<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Real Estate Broker Quiz - Revamped</title>

  <style>
    /*********************************************************
     * GLOBAL & THEME
     *********************************************************/
    :root {
      --primary-color: #2563eb;
      --primary-hover: #1d4ed8;
      --secondary-color: #4a5568;
      --light-blue:    #f0f8ff;
      --white:         #ffffff;
      --success-color: #0f9d58;
      --error-color:   #d93025;
      --warning-color: #faad14;

      --text-color-light: #444;
      --text-color-dark:  #f1f1f1;
    }

    body {
      margin: 0;
      padding: 0;
      width: 100%;
      min-height: 100vh;
      font-family: "Helvetica Neue", Arial, sans-serif;
      overflow-x: hidden;
      transition: background 0.3s ease, color 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      font-size: 1.125rem; 
      line-height: 1.6;
    }

    body.light-mode {
      background-color: var(--white);
      color: var(--text-color-light);
    }
    body.dark-mode {
      background-color: #2d3748;
      color: var(--text-color-dark);
    }

    * {
      box-sizing: border-box;
    }

    /*********************************************************
     * HAMBURGER MENU
     *********************************************************/
    .expandable-menu {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1000;
      text-align: center;
    }
    .menu-toggle-button {
      background: var(--primary-color);
      color: #fff;
      border: none;
      padding: 0.6rem 1rem;
      border-radius: 0.25rem;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: background-color 0.3s ease, transform 0.3s ease;
    }
    .menu-toggle-button:hover {
      background-color: var(--primary-hover);
      transform: scale(1.03);
    }
    .menu-content {
      display: none;
      margin-top: 0.5rem;
      background: var(--light-blue);
      padding: 0.5rem;
      border-radius: 0.25rem;
    }
    .menu-content.show {
      display: block;
    }
    .menu-btn {
      display: block;
      margin: 0.5rem auto;
      width: 100%;
      max-width: 180px;
      text-align: center;
      background: var(--primary-color);
      color: #fff;
      border: none;
      padding: 0.6rem 1rem;
      border-radius: 0.25rem;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: background-color 0.3s ease, transform 0.3s ease;
    }
    .menu-btn:hover {
      background-color: var(--primary-hover);
      transform: scale(1.03);
    }
    .menu-btn.btn-secondary {
      background-color: #eee;
      color: #444;
    }
    .menu-btn.btn-secondary:hover {
      background-color: #ddd;
    }
    #dark-mode-toggle {
      background: var(--secondary-color);
    }

    .audio-panel {
      background: var(--light-blue);
      border: 2px solid var(--primary-color);
      padding: 1rem;
      margin-top: 0.5rem;
      border-radius: 0.25rem;
      display: none;
      text-align: left;
    }
    body.dark-mode .audio-panel {
      background: #2d3748;
      border-color: var(--secondary-color);
      color: var(--text-color-dark);
    }
    .audio-panel h4 {
      margin-top: 0;
    }

    /*********************************************************
     * FULLSCREEN BUTTON
     *********************************************************/
    #fullscreen-btn {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      z-index: 999;
      background: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      font-size: 1.2rem;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      transition: transform 0.3s ease, background-color 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #fullscreen-btn:hover {
      background-color: var(--primary-hover);
      transform: scale(1.05);
    }

    /*********************************************************
     * NEW MAIN MENU
     *********************************************************/
    #new-main-menu {
      display: none; 
      text-align: center;
      margin-top: 2rem;
      animation: fadeIn 0.8s ease forwards; 
      opacity: 0;
      transform: translateY(10px);
    }
    #new-main-menu h1 {
      margin-bottom: 1.5rem;
      font-size: 2rem;
    }
    .menu-option-btn {
      display: inline-block;
      background-color: var(--primary-color);
      color: #fff;
      padding: 0.8rem 1.2rem;
      margin: 0.5rem;
      border: none;
      border-radius: 0.25rem;
      font-size: 1.2rem;
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.2s ease;
    }
    .menu-option-btn:hover {
      background-color: var(--primary-hover);
      transform: translateY(-1px);
    }

    /*********************************************************
     * STORY MODE MENU & CONTAINER
     *********************************************************/
    #story-menu {
      display: none;
      text-align: center;
      margin-top: 2rem;
      animation: fadeIn 0.8s ease forwards; 
      opacity: 0;
      transform: translateY(10px);
    }
    #story-menu h2 {
      margin-bottom: 1rem;
      font-size: 1.6rem;
      color: var(--text-color-light);
    }
    #story-menu .form-group {
      margin-bottom: 1.25rem;
      text-align: center;
    }
    #story-menu label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    #story-menu select {
      width: 100%;
      max-width: 300px;
      padding: 0.6rem;
      margin-bottom: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 0.25rem;
      outline: none;
      font-size: 1rem;
      text-align: center;
    }
    #story-menu button {
      margin-top: 1rem;
    }

    #story-mode-container {
      display: none;
      width: 100%;
      max-width: 800px;
      margin: 2rem auto;
      padding: 1rem;
      text-align: center;
    }
    #story-list-container {
      margin-top: 1rem;
    }

    .story-card {
      background: var(--light-blue);
      border: 1px solid #ccc;
      border-radius: 0.25rem;
      padding: 2rem;
      margin-bottom: 1.5rem;
      animation: fadeInUp 0.5s ease;
    }
    body.dark-mode .story-card {
      background: #2d3748;
      border-color: #444;
      color: var(--text-color-dark);
    }
    .story-key {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 1rem;
      white-space: normal;
    }
    .story-example {
      font-size: 1rem;
      line-height: 1.4;
      white-space: normal;
    }
    body.dark-mode .story-example {
      color: #ccc;
    }
    .story-next-btn {
      margin-top: 1rem;
    }

    /*********************************************************
     * QUIZ CONTAINER & ANIMATIONS
     *********************************************************/
    .container {
      width: 100%;
      max-width: 1200px;
      margin: 2rem 1rem;
      background: var(--white);
      border-radius: 0.5rem;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      animation: fadeInUp 0.6s ease forwards;
      opacity: 0;
      transform: translateY(20px);
      padding: 3rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background-color 0.3s ease;
      text-align: center;
    }
    @keyframes fadeIn {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    @keyframes fadeInUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    body.dark-mode .container {
      background-color: #1a202c;
      color: var(--text-color-dark);
      box-shadow: 0 8px 20px rgba(255, 255, 255, 0.15);
    }

    .btn {
      display: inline-block;
      padding: 0.75rem 1.5rem;
      background-color: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 0.25rem;
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: 600;
      transition: background-color 0.2s ease, transform 0.2s ease;
      margin-top: 1rem;
      text-align: center;
    }
    .btn:hover {
      background-color: var(--primary-hover);
      transform: translateY(-1px);
    }

    /*********************************************************
     * RESPONSIVE
     *********************************************************/
    @media (max-width: 768px) {
      .menu-toggle-button {
        font-size: 0.9rem;
      }
      .container {
        margin: 1rem;
        padding: 1.5rem;
      }
      #fullscreen-btn {
        bottom: 1rem;
        right: 1rem;
      }
      .story-card {
        padding: 1rem;
      }
    }
  </style>
</head>
<body class="light-mode">

  <!-- HAMBURGER MENU -->
  <div class="expandable-menu">
    <button id="menu-toggle" class="menu-toggle-button">☰ Menu</button>
    <div class="menu-content">
      <button class="menu-btn btn-secondary" id="back-to-menu-btn">Back to Main</button>
      <button class="menu-btn" id="dark-mode-toggle">Dark/Light</button>
      
      <button class="menu-btn" id="music-settings-btn">Music Settings</button>
      <div class="audio-panel" id="music-settings-panel">
        <h4>Music Settings</h4>
        <p><strong>Choose a track or turn music off:</strong></p>
        <label><input type="radio" name="music-track" value="-1" checked> Off</label><br>
        <label><input type="radio" name="music-track" value="0"> Music 1</label><br>
        <label><input type="radio" name="music-track" value="1"> Music 2</label><br>
        <label><input type="radio" name="music-track" value="2"> Music 3</label><br>
        <label><input type="radio" name="music-track" value="3"> Music 4</label><br><br>
        
        <label for="music-volume">Music Volume:</label>
        <input type="range" id="music-volume" min="0" max="1" step="0.1" value="1"><br>
        <button class="menu-btn btn-secondary" id="close-music-settings">Close</button>
      </div>

      <button class="menu-btn" id="sound-settings-btn">Sound Settings</button>
      <div class="audio-panel" id="sound-settings-panel">
        <h4>Sound Effects Settings</h4>
        <label>
          <input type="checkbox" id="toggle-sfx" checked> Enable SFX
        </label>
        <br><br>
        <label for="sfx-volume">SFX Volume:</label>
        <input type="range" id="sfx-volume" min="0" max="1" step="0.1" value="1"><br>
        <button class="menu-btn btn-secondary" id="close-sfx-settings">Close</button>
      </div>
    </div>
  </div>

  <!-- FULLSCREEN BUTTON -->
  <button id="fullscreen-btn" title="Toggle Fullscreen">⛶</button>

  <!-- NEW MAIN MENU -->
  <div id="new-main-menu">
    <h1>Main Menu</h1>
    <button class="menu-option-btn" id="go-to-story">Story Mode</button>
    <button class="menu-option-btn" id="go-to-quiz">Questions</button>
    <button class="menu-option-btn" id="go-to-options">Options for Now</button>
  </div>

  <!-- STORY MENU -->
  <div id="story-menu">
    <h2>Story Mode Selection</h2>
    <div class="form-group">
      <label for="story-chapter-select">Pick a Chapter (or All):</label>
      <select id="story-chapter-select">
        <option value="all">All Chapters</option>
        <!-- Single chapters: 1-12 -->
        <option value="1">Chapter 1</option>
        <option value="2">Chapter 2</option>
        <option value="3">Chapter 3</option>
        <option value="4">Chapter 4</option>
        <option value="5">Chapter 5</option>
        <option value="6">Chapter 6</option>
        <option value="7">Chapter 7</option>
        <option value="8">Chapter 8</option>
        <option value="9">Chapter 9</option>
        <option value="10">Chapter 10</option>
        <option value="11">Chapter 11</option>
        <option value="12">Chapter 12</option>
      </select>
    </div>
    <div class="form-group" id="story-count-group" style="display: none;">
      <label for="story-count-select">Number of Stories:</label>
      <select id="story-count-select">
        <option value="10">10</option>
        <option value="20">20</option>
        <option value="30">30</option>
        <option value="40">40</option>
      </select>
    </div>
    <div id="single-chapter-note" style="color:#666; font-size:0.9rem; display:none;">
      If you select a single chapter, <strong>8 random stories</strong> will be shown.
    </div>
    <button class="btn" id="start-story-btn">Start Story Mode</button>
  </div>

  <!-- STORY MODE CONTAINER -->
  <div id="story-mode-container">
    <h2 id="story-mode-title"></h2>
    <div id="story-list-container"></div>
    <!-- “Back to Main Menu” or “Done” will show after final story -->
    <button class="btn btn-secondary" id="back-to-main-story-menu-btn" style="display:none;">Back to Story Menu</button>
  </div>

  <!-- MAIN QUIZ CONTAINER -->
  <div class="container" id="main-container" style="display:none;">
    <!-- (Quiz content omitted for brevity) -->
    <h1>Quiz Goes Here...</h1>
  </div>

  <script>
    /***********************************************************
     * DOM ELEMENTS
     ***********************************************************/
    const menuToggle = document.getElementById('menu-toggle');
    const menuContent = document.querySelector('.menu-content');
    const backToMenuBtn = document.getElementById('back-to-menu-btn');
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    
    // Audio
    const musicSettingsBtn = document.getElementById('music-settings-btn');
    const musicSettingsPanel = document.getElementById('music-settings-panel');
    const closeMusicBtn = document.getElementById('close-music-settings');
    const soundSettingsBtn = document.getElementById('sound-settings-btn');
    const soundSettingsPanel = document.getElementById('sound-settings-panel');
    const closeSfxBtn = document.getElementById('close-sfx-settings');
    const sfxToggle = document.getElementById('toggle-sfx');
    const sfxVolumeSlider = document.getElementById('sfx-volume');
    const musicRadioInputs = document.querySelectorAll('input[name="music-track"]');
    const musicVolumeSlider = document.getElementById('music-volume');

    // New main menu
    const newMainMenu = document.getElementById('new-main-menu');
    const goToStoryBtn = document.getElementById('go-to-story');
    const goToQuizBtn = document.getElementById('go-to-quiz');
    const goToOptionsBtn = document.getElementById('go-to-options');

    // Story menu & container
    const storyMenu = document.getElementById('story-menu');
    const storyChapterSelect = document.getElementById('story-chapter-select');
    const storyCountGroup = document.getElementById('story-count-group');
    const storyCountSelect = document.getElementById('story-count-select');
    const singleChapterNote = document.getElementById('single-chapter-note');
    const startStoryBtn = document.getElementById('start-story-btn');
    const storyModeContainer = document.getElementById('story-mode-container');
    const storyModeTitle = document.getElementById('story-mode-title');
    const storyListContainer = document.getElementById('story-list-container');
    const backToMainStoryMenuBtn = document.getElementById('back-to-main-story-menu-btn');

    // Quiz container
    const mainContainer = document.getElementById('main-container');

    /***********************************************************
     * AUDIO SETUP
     ***********************************************************/
    let sfxEnabled = true;
    const correctSound = new Audio('sound/sound effects/correct.wav');
    const tapSound    = new Audio('sound/sound effects/tap.wav');
    const wrongSound  = new Audio('sound/sound effects/wrong.wav');
    const musicTracks = [
      new Audio('sound/music/music_1.mp3'),
      new Audio('sound/music/music_2.mp3'),
      new Audio('sound/music/music_3.mp3'),
      new Audio('sound/music/music_4.mp3')
    ];
    musicTracks.forEach(m => m.loop = true);
    let currentMusicIndex = -1;

    /***********************************************************
     * STORY MODE STATE
     ***********************************************************/
    let combinedStories = [];
    let currentStoryIndex = 0;
    let chosenStoryCount = 8;  // default for single chapter
    let currentStories = [];

    /***********************************************************
     * EVENT LISTENERS
     ***********************************************************/
    // On load, show newMainMenu
    window.addEventListener('load', () => {
      newMainMenu.style.display = 'block'; // default
    });

    // Hamburger menu
    menuToggle.addEventListener('click', () => {
      menuContent.classList.toggle('show');
      playSFX('tap');
    });
    backToMenuBtn.addEventListener('click', () => {
      playSFX('tap');
      goBackToMainMenu();
    });

    // Dark mode toggle
    darkModeToggle.addEventListener('click', () => {
      playSFX('tap');
      toggleDarkMode();
    });

    // Fullscreen toggle
    fullscreenBtn.addEventListener('click', () => {
      playSFX('tap');
      toggleFullScreen();
    });

    // Audio settings
    musicSettingsBtn.addEventListener('click', () => {
      playSFX('tap');
      musicSettingsPanel.style.display = (musicSettingsPanel.style.display === 'block') ? 'none' : 'block';
      soundSettingsPanel.style.display = 'none';
    });
    closeMusicBtn.addEventListener('click', () => {
      playSFX('tap');
      musicSettingsPanel.style.display = 'none';
    });
    soundSettingsBtn.addEventListener('click', () => {
      playSFX('tap');
      soundSettingsPanel.style.display = (soundSettingsPanel.style.display === 'block') ? 'none' : 'block';
      musicSettingsPanel.style.display = 'none';
    });
    closeSfxBtn.addEventListener('click', () => {
      playSFX('tap');
      soundSettingsPanel.style.display = 'none';
    });
    musicRadioInputs.forEach(r => {
      r.addEventListener('change', () => {
        updateMusicChoice(parseInt(r.value,10));
      });
    });
    musicVolumeSlider.addEventListener('input', () => {
      const vol = parseFloat(musicVolumeSlider.value);
      musicTracks.forEach(m => m.volume = vol);
    });
    sfxToggle.addEventListener('change', () => {
      sfxEnabled = sfxToggle.checked;
    });
    sfxVolumeSlider.addEventListener('input', () => {
      const vol = parseFloat(sfxVolumeSlider.value);
      correctSound.volume = vol;
      tapSound.volume     = vol;
      wrongSound.volume   = vol;
    });

    // New Main Menu
    goToStoryBtn.addEventListener('click', () => {
      playSFX('tap');
      newMainMenu.style.display = 'none';
      storyMenu.style.display = 'block';
    });
    goToQuizBtn.addEventListener('click', () => {
      playSFX('tap');
      newMainMenu.style.display = 'none';
      mainContainer.style.display = 'block';
    });
    goToOptionsBtn.addEventListener('click', () => {
      playSFX('tap');
      alert('Options placeholder!');
    });

    // Story Menu
    storyChapterSelect.addEventListener('change', () => {
      const val = storyChapterSelect.value;
      if (val === 'all') {
        // Show story-count-group for 10,20,30,40
        storyCountGroup.style.display = 'block';
        singleChapterNote.style.display = 'none';
      } else {
        // Single chapter => 8 stories
        storyCountGroup.style.display = 'none';
        singleChapterNote.style.display = 'block';
      }
    });

    startStoryBtn.addEventListener('click', async () => {
      playSFX('tap');
      // Show story mode container
      storyMenu.style.display = 'none';
      storyModeContainer.style.display = 'block';

      currentStoryIndex = 0;
      currentStories = []; // reset

      const chosenChapter = storyChapterSelect.value;
      if (chosenChapter === 'all') {
        // user wants all chapters
        chosenStoryCount = parseInt(storyCountSelect.value,10); // 10,20,30,40
        currentStories = await fetchAllChapters();
      } else {
        // single chapter => always 8
        chosenStoryCount = 8;
        currentStories = await fetchSingleChapter(chosenChapter);
      }
      shuffleArray(currentStories);
      if (currentStories.length > chosenStoryCount) {
        currentStories = currentStories.slice(0, chosenStoryCount);
      }

      // Display
      storyModeTitle.textContent = (chosenChapter==='all')
        ? `Showing ${chosenStoryCount} Stories from All Chapters`
        : `Showing 8 Stories from Chapter ${chosenChapter}`;

      loadCurrentStory();
    });

    backToMainStoryMenuBtn.addEventListener('click', () => {
      playSFX('tap');
      storyModeContainer.style.display = 'none';
      storyMenu.style.display = 'block';
    });

    /***********************************************************
     * STORY FETCH FUNCTIONS
     * We'll assume your JSON is at data/story/chapter_X.json
     ***********************************************************/
    async function fetchSingleChapter(chapterNum) {
      const url = `data/story/chapter_${chapterNum}.json`;
      try {
        const resp = await fetch(url);
        if (!resp.ok) {
          console.warn(`Could not fetch Chapter ${chapterNum}`);
          return [];
        }
        const data = await resp.json();
        return data.entries || [];
      } catch (err) {
        console.error('Error fetching single chapter:', err);
        return [];
      }
    }

    async function fetchAllChapters() {
      let all = [];
      for (let i = 1; i <= 12; i++) {
        const chunk = await fetchSingleChapter(i);
        all = all.concat(chunk);
      }
      return all;
    }

    /***********************************************************
     * STORY PRESENTATION (ONE AT A TIME)
     ***********************************************************/
    function loadCurrentStory() {
      // If we've passed the last story
      if (currentStoryIndex >= currentStories.length) {
        storyListContainer.innerHTML = '';
        backToMainStoryMenuBtn.style.display = 'inline-block'; 
        return;
      }
      backToMainStoryMenuBtn.style.display = 'none'; 
      storyListContainer.innerHTML = ''; // clear old

      const story = currentStories[currentStoryIndex];
      const card = document.createElement('div');
      card.classList.add('story-card');

      const keyDiv = document.createElement('div');
      keyDiv.classList.add('story-key');
      keyDiv.textContent = story.keyTakeaway || 'Key Takeaway (missing)';

      const exDiv = document.createElement('div');
      exDiv.classList.add('story-example');
      exDiv.textContent = story.exampleStory || 'Example story text missing.';

      card.appendChild(keyDiv);
      card.appendChild(exDiv);

      // Next button
      const nextBtn = document.createElement('button');
      nextBtn.classList.add('btn','story-next-btn');
      nextBtn.textContent = (currentStoryIndex < currentStories.length - 1)
        ? 'Next'
        : 'Finish';

      nextBtn.addEventListener('click', () => {
        playSFX('tap');
        currentStoryIndex++;
        loadCurrentStory();
      });
      card.appendChild(nextBtn);

      storyListContainer.appendChild(card);
    }

    /***********************************************************
     * HELPER: SHUFFLE
     ***********************************************************/
    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    /***********************************************************
     * GO BACK TO MAIN MENU
     ***********************************************************/
    function goBackToMainMenu() {
      // Hide everything else
      storyModeContainer.style.display = 'none';
      storyMenu.style.display = 'none';
      newMainMenu.style.display = 'block';
      mainContainer.style.display = 'none';
    }

    /***********************************************************
     * DARK MODE
     ***********************************************************/
    function toggleDarkMode() {
      const bodyClass = document.body.classList;
      if (bodyClass.contains('light-mode')) {
        bodyClass.remove('light-mode');
        bodyClass.add('dark-mode');
      } else {
        bodyClass.remove('dark-mode');
        bodyClass.add('light-mode');
      }
    }

    /***********************************************************
     * FULLSCREEN
     ***********************************************************/
    function toggleFullScreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
          alert(`Error attempting to enable fullscreen mode: ${err.message}`);
        });
      } else {
        document.exitFullscreen();
      }
    }

    /***********************************************************
     * AUDIO CHOICES
     ***********************************************************/
    function updateMusicChoice(index) {
      // stop old track
      if (currentMusicIndex >= 0 && currentMusicIndex < musicTracks.length) {
        musicTracks[currentMusicIndex].pause();
        musicTracks[currentMusicIndex].currentTime = 0;
      }
      currentMusicIndex = index;
      if (index >= 0 && index < musicTracks.length) {
        musicTracks[index].play();
      }
    }

    /***********************************************************
     * PLAY SFX
     ***********************************************************/
    function playSFX(type) {
      if (!sfxEnabled) return;
      let sound = null;
      switch(type) {
        case 'correct': sound = correctSound; break;
        case 'wrong':   sound = wrongSound;   break;
        case 'tap':     sound = tapSound;     break;
        default: return;
      }
      sound.currentTime = 0;
      sound.play();
    }
  </script>
</body>
</html>
