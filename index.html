<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Real Estate Broker Quiz</title>

  <style>
    :root {
      --primary-color: #2563eb;
      --primary-hover: #1d4ed8;
      --secondary-color: #4a5568;
      --dark-bg: #2d3748;
      --light-bg: #f7f9fc;
      --light-text: #333;
      --dark-text: #f1f1f1;
      --success-color: #0f9d58;
      --error-color: #d93025;
    }

    body {
      margin: 0; padding: 0;
      font-family: sans-serif;
      transition: background 0.3s, color 0.3s;
    }
    body.light-mode {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: var(--light-text);
    }
    body.dark-mode {
      background: var(--dark-bg);
      color: var(--dark-text);
    }

    .container {
      max-width: 800px; width: 100%;
      margin: 2rem auto; padding: 1.5rem;
      background: #fff; border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: background-color 0.3s;
    }
    body.dark-mode .container {
      background: #1a202c;
    }

    h1, h2 {
      text-align: center; margin-bottom: 1rem;
    }
    h1 { margin-top: 0; }

    .top-right-menu {
      position: fixed; top: 1rem; right: 1rem;
      display: flex; gap: 0.5rem;
      z-index: 999;
    }
    button {
      padding: 0.5rem 1rem; border: none; border-radius: 4px;
      cursor: pointer; background: var(--primary-color); color: #fff;
      transition: background 0.2s, transform 0.2s;
    }
    button:hover {
      background: var(--primary-hover); transform: scale(1.03);
    }
    .btn-secondary {
      background: #ccc; color: #000;
    }

    .form-group { text-align: center; margin-bottom: 1rem; }
    select {
      padding: 0.5rem; margin: 0.5rem 0;
      border-radius: 4px; border: 1px solid #ccc;
    }

    #quiz-section, #result-section {
      display: none;
    }
    .question-container {
      margin-bottom: 1.5rem;
      background: var(--light-bg);
      padding: 1rem; border-radius: 6px;
      transition: background-color 0.2s;
    }
    body.dark-mode .question-container {
      background: #2d3748; color: var(--dark-text);
    }
    .options-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem; margin-top: 1rem;
    }
    .option-block {
      background: #f9f9f9; padding: 1rem;
      border: 1px solid #ccc; border-radius: 4px;
      cursor: pointer; text-align: center;
    }
    .option-block:hover {
      background: #eee; transform: scale(1.02);
    }
    .option-block.correct {
      background: #c8f7c5; border-color: var(--success-color);
    }
    .option-block.wrong {
      background: #f7c5c5; border-color: var(--error-color);
    }

    .progress-bar {
      width: 100%; height: 10px; background: #ddd;
      border-radius: 5px; overflow: hidden; margin-bottom: 1rem;
    }
    .progress-fill {
      width: 0%; height: 100%;
      background: var(--primary-color); transition: width 0.3s;
    }

    .remaining-count, #timer {
      text-align: center; margin: 0.5rem 0;
      font-weight: bold;
    }
    #timer-container { display: none; text-align: center; }

    .vertical-radio-list label {
      display: block; margin: 0.4rem 0;
    }

    @media (max-width: 768px) {
      .options-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body class="light-mode">

  <!-- TOP-RIGHT MENU -->
  <div class="top-right-menu">
    <button id="dark-mode-toggle">Dark/Light</button>
    <button id="back-to-menu-btn" class="btn-secondary">Back to Main</button>
  </div>

  <div class="container">

    <!-- START MENU -->
    <div id="start-menu">
      <h1>Real Estate Broker Quiz</h1>
      <p style="text-align:center;">
        Select a chapter or “All Chapters,” choose how many questions you’d like, pick a display format, and optionally enable a timer.
      </p>

      <div class="form-group">
        <label for="chapter-select">Chapter:</label><br>
        <select id="chapter-select">
          <option value="all">All Chapters</option>
          <option value="1">Chapter 1</option>
          <option value="2">Chapter 2</option>
          <option value="3">Chapter 3</option>
          <option value="4">Chapter 4</option>
          <option value="5">Chapter 5</option>
          <option value="6">Chapter 6</option>
          <option value="7">Chapter 7</option>
          <option value="8">Chapter 8</option>
          <option value="9">Chapter 9</option>
          <option value="10">Chapter 10</option>
          <option value="11">Chapter 11</option>
          <option value="12">Chapter 12</option>
        </select>
      </div>

      <div class="form-group">
        <label for="question-count-select">Number of Questions:</label><br>
        <select id="question-count-select"></select>
      </div>

      <div class="form-group">
        <label>Display Format:</label><br>
        <div>
          <label><input type="radio" name="format" value="allAtOnce" checked> All At Once</label>
          <label><input type="radio" name="format" value="oneAtATime"> One At A Time</label>
        </div>
      </div>

      <div class="form-group">
        <label for="timer-toggle">Enable Timer?</label>
        <input type="checkbox" id="timer-toggle">
      </div>

      <div style="text-align:center;">
        <button id="start-quiz-btn">Start Quiz</button>
      </div>
    </div>
    <!-- END START MENU -->

    <!-- QUIZ SECTION -->
    <div id="quiz-section">
      <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
      <div class="remaining-count" id="remaining-count"></div>

      <div id="timer-container">
        <div id="timer">Time: 00:00</div>
        <button id="pause-timer-btn">Pause</button>
      </div>

      <div id="quiz-questions-container"></div>

      <div style="text-align:center; margin-top:1rem;">
        <button id="next-question-btn" style="display:none;">Next Question</button>
        <button id="submit-btn" style="display:none;">Submit Quiz</button>
      </div>
    </div>
    <!-- END QUIZ SECTION -->

    <!-- RESULT SECTION -->
    <div id="result-section">
      <h2>Results</h2>
      <div id="score-display" style="font-weight:bold; margin-bottom:1rem;"></div>
      <div style="text-align:center;">
        <button id="restart-btn" class="btn-secondary">Restart</button>
      </div>
    </div>
    <!-- END RESULT SECTION -->

  </div> <!-- end .container -->


  <script>
    /************************************************************
     * DOM ELEMENTS
     ************************************************************/
    const startMenu           = document.getElementById('start-menu');
    const quizSection         = document.getElementById('quiz-section');
    const resultSection       = document.getElementById('result-section');
    const quizContainer       = document.getElementById('quiz-questions-container');

    const chapterSelect       = document.getElementById('chapter-select');
    const questionCountSelect = document.getElementById('question-count-select');
    const formatRadios        = document.querySelectorAll('input[name="format"]');
    const timerToggle         = document.getElementById('timer-toggle');

    const startQuizBtn        = document.getElementById('start-quiz-btn');
    const nextQuestionBtn     = document.getElementById('next-question-btn');
    const submitBtn           = document.getElementById('submit-btn');
    const restartBtn          = document.getElementById('restart-btn');
    const backToMenuBtn       = document.getElementById('back-to-menu-btn');

    // Timer DOM
    const timerContainer      = document.getElementById('timer-container');
    const timerEl             = document.getElementById('timer');
    const pauseTimerBtn       = document.getElementById('pause-timer-btn');

    // Progress & remaining
    const progressFill        = document.getElementById('progress-fill');
    const remainingCountEl    = document.getElementById('remaining-count');
    const scoreDisplay        = document.getElementById('score-display');

    // Dark mode
    const darkModeToggle      = document.getElementById('dark-mode-toggle');

    /************************************************************
     * QUIZ STATE
     ************************************************************/
    let currentQuestions = [];
    let questionQueue    = [];
    let userAnswers      = [];
    let chosenFormat     = 'allAtOnce';
    let totalQuestions   = 0;

    // Timer variables
    let timerInterval    = null;
    let timeElapsed      = 0;
    let isTimerRunning   = false;

    /************************************************************
     * CHAPTER -> QUESTION COUNT MAP
     * Adjust to match how many questions each chapter JSON has.
     ************************************************************/
    const CHAPTER_QUESTION_OPTIONS = {
      all: [5, 10, 15, 20],  // pick whichever sizes you like
      1:  [3, 5, 8],
      2:  [3, 5, 8],
      3:  [3, 5, 8],
      4:  [3, 5, 8],
      5:  [3, 5, 8],
      6:  [3, 5, 8],
      7:  [3, 5, 8],
      8:  [3, 5, 8],
      9:  [3, 5, 8],
      10: [3, 5, 8],
      11: [3, 5, 8],
      12: [3, 5, 8],
    };

    /************************************************************
     * EVENT LISTENERS
     ************************************************************/
    document.addEventListener('DOMContentLoaded', updateQuestionCountOptions);
    chapterSelect.addEventListener('change', updateQuestionCountOptions);

    startQuizBtn.addEventListener('click', startQuiz);
    nextQuestionBtn.addEventListener('click', () => {}); // we override it dynamically

    submitBtn.addEventListener('click', handleSubmitQuiz);

    restartBtn.addEventListener('click', resetQuiz);
    backToMenuBtn.addEventListener('click', resetQuiz);

    pauseTimerBtn.addEventListener('click', toggleTimer);

    darkModeToggle.addEventListener('click', toggleDarkMode);

    /************************************************************
     * DYNAMIC QUESTION COUNT
     ************************************************************/
    function updateQuestionCountOptions() {
      const selectedChapter = chapterSelect.value;
      const options = CHAPTER_QUESTION_OPTIONS[selectedChapter] || [5];
      questionCountSelect.innerHTML = '';
      options.forEach(num => {
        const opt = document.createElement('option');
        opt.value = num;
        opt.textContent = num;
        questionCountSelect.appendChild(opt);
      });
    }

    /************************************************************
     * START QUIZ
     ************************************************************/
    async function startQuiz() {
      startMenu.style.display   = 'none';
      quizSection.style.display = 'block';
      resultSection.style.display = 'none';

      chosenFormat = [...formatRadios].find(r => r.checked).value;

      const chapterValue = chapterSelect.value;
      totalQuestions     = parseInt(questionCountSelect.value, 10);

      // Fetch the relevant questions
      let allFetched = [];
      if (chapterValue === 'all') {
        // Fetch all 12 chapters and merge them
        for (let i = 1; i <= 12; i++) {
          const data = await fetchChapter(i);
          allFetched = [...allFetched, ...data];
        }
      } else {
        allFetched = await fetchChapter(chapterValue);
      }

      // Thoroughly shuffle
      shuffleArray(allFetched);
      // Slice down to user’s chosen count
      currentQuestions = allFetched.slice(0, totalQuestions);

      // For each question, shuffle the options & update correct index
      currentQuestions.forEach(q => {
        shuffleArray(q.options);
        q.correctOption = q.options.indexOf(q.correctAnswer);
      });

      // Initialize progress bar & timer
      updateProgressBar(0);
      if (timerToggle.checked) {
        timerContainer.style.display = 'block';
        startTimer();
      } else {
        timerContainer.style.display = 'none';
      }

      // Render
      if (chosenFormat === 'allAtOnce') {
        userAnswers = [];
        nextQuestionBtn.style.display = 'none';
        submitBtn.style.display       = 'inline-block';
        renderAllAtOnce(currentQuestions);
        remainingCountEl.textContent  = '';
      } else {
        // One at a time
        nextQuestionBtn.style.display = 'none';
        submitBtn.style.display       = 'none';
        questionQueue = [...currentQuestions];
        updateRemainingCount();
        showNextOneAtATime();
      }
    }

    /************************************************************
     * FETCH FROM JSON (in assets/ folder)
     ************************************************************/
    async function fetchChapter(chapterNum) {
      const url = `assets/chapter${chapterNum}.json`;
      try {
        const resp = await fetch(url);
        if (!resp.ok) {
          console.warn(`Failed to load ${url}.`);
          return [];
        }
        const jsonData = await resp.json();
        return jsonData.questions || [];
      } catch (err) {
        console.error(`Error fetching ${url}`, err);
        return [];
      }
    }

    /************************************************************
     * ALL-AT-ONCE RENDER
     ************************************************************/
    function renderAllAtOnce(questions) {
      quizContainer.innerHTML = '';
      questions.forEach((q, idx) => {
        const questionDiv = document.createElement('div');
        questionDiv.classList.add('question-container');

        const h3 = document.createElement('h3');
        h3.textContent = `Q${idx+1}: ${q.questionText}`;
        questionDiv.appendChild(h3);

        const optsWrapper = document.createElement('div');
        optsWrapper.classList.add('vertical-radio-list');

        q.options.forEach((optText, optIdx) => {
          const label = document.createElement('label');
          const radio = document.createElement('input');
          radio.type = 'radio';
          radio.name = `q${idx}`;
          radio.value = optIdx;
          radio.addEventListener('change', () => {
            userAnswers[idx] = optIdx;
          });

          label.appendChild(radio);
          label.appendChild(document.createTextNode(' ' + optText));
          optsWrapper.appendChild(label);
        });

        questionDiv.appendChild(optsWrapper);
        quizContainer.appendChild(questionDiv);
      });
    }

    /************************************************************
     * ONE-AT-A-TIME MODE
     ************************************************************/
    function showNextOneAtATime() {
      if (questionQueue.length === 0) {
        finishOneAtATime();
        return;
      }
      quizContainer.innerHTML = '';
      const q = questionQueue[0];

      const questionDiv = document.createElement('div');
      questionDiv.classList.add('question-container');

      const h3 = document.createElement('h3');
      h3.textContent = `Question: ${q.questionText}`;
      questionDiv.appendChild(h3);

      const grid = document.createElement('div');
      grid.classList.add('options-grid');

      // Re-shuffle to randomize each display
      shuffleArray(q.options);
      q.correctOption = q.options.indexOf(q.correctAnswer);

      q.options.forEach((optText, optIdx) => {
        const block = document.createElement('div');
        block.classList.add('option-block');
        block.textContent = optText;

        block.addEventListener('click', () => {
          // disable clicks
          Array.from(grid.children).forEach(el => el.style.pointerEvents = 'none');

          const isCorrect = (optIdx === q.correctOption);
          block.classList.add(isCorrect ? 'correct' : 'wrong');

          // Show explanation if present
          if (q.explanation) {
            const expl = document.createElement('p');
            expl.style.fontStyle = 'italic';
            expl.textContent = q.explanation;
            questionDiv.appendChild(expl);
          }

          // Show next button
          nextQuestionBtn.style.display = 'inline-block';
          nextQuestionBtn.onclick = () => {
            nextQuestionBtn.style.display = 'none';
            if (isCorrect) {
              questionQueue.shift();
            } else {
              questionQueue.push(questionQueue.shift());
            }
            updateRemainingCount();
            updateProgressBar(totalQuestions - questionQueue.length);
            showNextOneAtATime();
          };
        });

        grid.appendChild(block);
      });

      questionDiv.appendChild(grid);
      quizContainer.appendChild(questionDiv);
    }

    function finishOneAtATime() {
      quizSection.style.display = 'none';
      resultSection.style.display = 'block';
      stopTimer();
      scoreDisplay.textContent =
        `You eventually got them all correct! Time: ${formatTime(timeElapsed)}`;
    }

    /************************************************************
     * SUBMIT (ALL-AT-ONCE)
     ************************************************************/
    function handleSubmitQuiz() {
      let score = 0;
      currentQuestions.forEach((q, i) => {
        if (userAnswers[i] === q.correctOption) {
          score++;
        }
      });
      quizSection.style.display = 'none';
      resultSection.style.display = 'block';
      stopTimer();
      scoreDisplay.textContent =
        `You answered ${score} out of ${currentQuestions.length} correctly in ${formatTime(timeElapsed)}.`;
    }

    /************************************************************
     * RESET QUIZ
     ************************************************************/
    function resetQuiz() {
      startMenu.style.display   = 'block';
      quizSection.style.display = 'none';
      resultSection.style.display = 'none';

      // Stop timer & reset
      stopTimer();
      timeElapsed = 0;
      timerEl.textContent = 'Time: 00:00';
      timerContainer.style.display = 'none';

      // Clear data
      currentQuestions = [];
      questionQueue    = [];
      userAnswers      = [];
      updateProgressBar(0);
      remainingCountEl.textContent = '';
    }

    /************************************************************
     * TIMER & PROGRESS
     ************************************************************/
    function startTimer() {
      if (isTimerRunning) return;
      isTimerRunning = true;
      timerInterval = setInterval(() => {
        timeElapsed++;
        timerEl.textContent = `Time: ${formatTime(timeElapsed)}`;
      }, 1000);
    }

    function stopTimer() {
      clearInterval(timerInterval);
      timerInterval = null;
      isTimerRunning = false;
    }

    function toggleTimer() {
      if (isTimerRunning) {
        stopTimer();
        pauseTimerBtn.textContent = 'Resume';
      } else {
        startTimer();
        pauseTimerBtn.textContent = 'Pause';
      }
    }

    function formatTime(sec) {
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return (m<10?'0':'') + m + ':' + (s<10?'0':'') + s;
    }

    function updateProgressBar(completed) {
      const pct = (completed / totalQuestions) * 100;
      progressFill.style.width = pct + '%';
    }

    function updateRemainingCount() {
      remainingCountEl.textContent =
        `Remaining: ${questionQueue.length} question(s)`;
    }

    /************************************************************
     * DARK/LIGHT MODE
     ************************************************************/
    function toggleDarkMode() {
      const body = document.body;
      if (body.classList.contains('light-mode')) {
        body.classList.remove('light-mode');
        body.classList.add('dark-mode');
      } else {
        body.classList.remove('dark-mode');
        body.classList.add('light-mode');
      }
    }

    /************************************************************
     * SHUFFLE
     ************************************************************/
    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }
  </script>
</body>
</html>